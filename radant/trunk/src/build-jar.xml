<?xml version="1.0" encoding="UTF-8"?> 
<project name="radant-jar" default="dist"> 
  <import file="fragments/build-properties-files.xml"/>
  <import file="fragments/build-commons.xml"/>

	<property name="src.dir" value="src" />
	<property name="test.dir" value="test" />
	<property name="classes.dir" value="bin" />
	<property name="dist.dir" value="dist" />
  <property name="lib.dir" location="lib" />
  <property name="test.reports.dir" location="${dist.dir}/reports" />

  <property name="javac.target" value="1.6" />
  <property name="javac.debug" value="on" />

	<path id="jar.classpath">
		<fileset dir="${lib.dir}" includes="**/*.jar"/>
	</path>

  <path id="test.classpath">
    <pathelement location="${classes.dir}"/>
    <path refid="jar.classpath"/>
  </path>

  <!-- - - - - - - - - - - - - - - - - - --> 
  <!-- bootstrap                         --> 
  <!-- - - - - - - - - - - - - - - - - - --> 
  <target name="bootstrap" depends="init" description="Create project folders from sratch"> 
    <mkdir dir="${src.dir}"/>
    <mkdir dir="${test.dir}"/>
    <mkdir dir="${lib.dir}"/>
  </target>

  <!-- - - - - - - - - - - - - - - - - - --> 
  <!-- compile                           -->
  <!-- - - - - - - - - - - - - - - - - - -->
  <target name="compile" depends="init">
  	<javac target="${javac.target}" destdir="${classes.dir}" debug="${javac.debug}" debuglevel="lines,source" 
      classpathref="jar.classpath" includeantruntime="false">
      <src path="${src.dir}"/>
      <src path="${test.dir}"/>
    </javac>
  	<copy todir="${classes.dir}" overwrite="true">
  		<fileset dir="${src.dir}" excludes="**/*.java"/>
  	</copy>
  </target>

  <!-- - - - - - - - - - - - - - - - - - --> 
  <!-- jar                               -->
  <!-- - - - - - - - - - - - - - - - - - -->
  <target name="jar" depends="compile" description="create the jar file">
  	<jar basedir="${classes.dir}" destfile="${dist.dir}/${ant.project.name}-${version}.jar">
      <manifest>
		  <section name="${ant.project.name}">
	      <attribute name="Implementation-Title" value="${ant.project.name}"/>
	      <attribute name="Implementation-Version" value="${version} ${TODAY}"/> 
	      <attribute name="Implementation-Vendor" value="${manifest-vendor}"/>
	    </section>
			</manifest>
   	</jar>
  </target>

  <!-- - - - - - - - - - - - - - - - - - -->
  <!-- test                              -->
  <!-- - - - - - - - - - - - - - - - - - -->
  <target name="test" depends="compile" description="run junit tests">
    <mkdir dir="${test.reports.dir}"/>

    <junit printsummary="yes" haltonfailure="false" haltonerror="false" errorproperty="junit.error" failureproperty="junit.failure">
      <classpath refid="test.classpath"/>
      <formatter type="plain" usefile="false"/>
      <formatter type="xml" usefile="true"/>

      <batchtest fork="yes" todir="${test.reports.dir}">
        <fileset dir="${test.dir}" includes="**/*Test.java"/>
      </batchtest>
    </junit>
  </target>

  <!-- - - - - - - - - - - - - - - - - - -->
  <!-- reports                           -->
  <!-- - - - - - - - - - - - - - - - - - -->
  <target name="reports" depends="test" description="create html reports of junit tests">
    <junitreport todir="${test.reports.dir}">
      <fileset dir="${test.reports.dir}">
        <include name="TEST-*.xml"/>
      </fileset>
      <report format="noframes" todir="${test.reports.dir}"/>
    </junitreport>
    <fail message="At least an error occured during tests" if="${junit.error}" />
    <fail message="At least a failure occured during tests" if="${junit.failure}" />
  </target>

  <!-- - - - - - - - - - - - - - - - - - --> 
  <!-- dist                              --> 
  <!-- - - - - - - - - - - - - - - - - - --> 
  <target name="dist" depends="jar,reports" description="create final artifact and run tests"/>
</project>
 
